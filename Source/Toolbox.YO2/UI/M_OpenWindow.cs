/* Generated by MyraPad at 9/7/2022 4:14:03 PM */


using System.Linq;

using Microsoft.Xna.Framework;

using Myra.Graphics2D.UI;
using Orts.Models.Simplified;
using Orts.Formats.Msts;
using System.Drawing.Text;

using ListItem = Myra.Graphics2D.UI.ListItem;
using System.Collections.Generic;
using System.Windows.Forms;
using System.IO;
using System;
using Orts.Formats.Msts.Files;
using Toolbox.YO2;

namespace Toolbox.YO2
{
	public partial class M_OpenWindow
	{
        private GameWindow gameWindow;

        private readonly M_Trains mw = new M_Trains();
        private readonly M_Equip me = new M_Equip();
        private readonly M_3DEquipViewer m3d = new M_3DEquipViewer();
        private M_ProgressBar pw = new M_ProgressBar();

        public M_OpenWindow(GameWindow gameWindow)
        {
            this.gameWindow = gameWindow;
            BuildUI();

            // Populate Routes
            // 


            foreach (Folder folder in gameWindow.folders)
            {
                var listItem = new ListItem();
                listItem.Text = folder.Name;
                listItem.Color = Color.White;
                _OpenWin_List.Items.Add(listItem);
            }


            _OpenWin_Cancel_button.Click += _OpenWin_Cancel_button_Click;
            _OpenWin_Load_button.Click += _OpenWin_Load_button_Click;




        }

        private async void _OpenWin_Load_button_Click(object sender, System.EventArgs e)
        {

            this.Close();
            var routeselected = " ";
            int count_i = 0;
            int dirlist_i = 0;
            int equiplist_i = 0;
            if (_OpenWin_List.SelectedItem == null)
                routeselected = "Route not Selected";
            else
            {
                foreach (Folder folder in gameWindow.folders)
                {
                    if (folder.Name == _OpenWin_List.SelectedItem.Text)
                    {
                        
                        await gameWindow.LoadConsists(folder).ConfigureAwait(true);
                        routeselected = folder.Name;

                        foreach (Consist consist in gameWindow.consists)
                        {
                            var listItem = new ListItem();
                            listItem.Text = consist.Name;
                            listItem.Color = Color.White;
                            mw._ConsistList.Items.Add(listItem);
                            count_i++;
                        }
 
                        var folderpath = folder.Path;
                        var trainsetpath = folderpath + "\\TRAINS\\TRAINSET";
                        var dirInfo = new DirectoryInfo(trainsetpath);
                        var directoryCount = Directory.GetDirectories(trainsetpath, "*", SearchOption.AllDirectories).Length;
                        var dirs = dirInfo.EnumerateDirectories("*", new EnumerationOptions
                        { RecurseSubdirectories = true });

                        pw.m_progressBar_tb.Text = "Processing " + dirlist_i.ToString() + " of " + directoryCount.ToString() + " Trainset Directories";

                        pw.ShowModal(gameWindow._desktop);
                        pw.BringToFront();



                        foreach (var name in dirs)
                        {
                            var path = name.ToString();

                            var result = Directory.EnumerateFiles(path, "*.eng",
                                SearchOption.AllDirectories).Union(Directory.EnumerateFiles(path, "*.wag",
                                SearchOption.AllDirectories));

                            foreach (var file in result)
                            {
                                var engFile = new CEeng(file);
                                var wagFile = new CEwag(file);
                                var listItem = new ListItem();
                                if (System.IO.Path.GetExtension(file) == ".eng")
                                    listItem.Text = engFile.Name;
                                else 
                                    listItem.Text = wagFile.Name;
                                listItem.Color = Color.White;
                                me._EqpList.Items.Add(listItem);
                                equiplist_i++;
                            }
                            
                            dirlist_i++;

                            pw.m_progressBar_tb.Text = "Processing " + dirlist_i.ToString() + " of " + directoryCount.ToString() + " Trainset Directories";
                            
                            
                        }
                        pw.Close();

                        me._EqpTotal.Text = equiplist_i.ToString() + "/" +dirlist_i.ToString();
                        mw._TrainCount.Text = count_i.ToString();
                        mw.Show(gameWindow._desktop, new Point(1, 21));
                        me.Show(gameWindow._desktop, new Point(252, 21));
                        m3d.Show(gameWindow._desktop, new Point(502, 21));
                        break;
                    }
                }
            }

            //          var messageBox = Dialog.CreateMessageBox("YardOffice", routeselected + " Number of Consists = " + count_i.ToString());


            //          messageBox.ShowModal(Desktop);

            

        }

        private void _OpenWin_Cancel_button_Click(object sender, System.EventArgs e)
        {
            base.Result = false;
            Close();
        }

    }
}